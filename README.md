<!-- License

Copyright 2022-2023 Neuromechatronics Lab, Carnegie Mellon University (a.whit)

Contributors: 
  a. whit. (nml@whit.contact)

This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at https://mozilla.org/MPL/2.0/.
-->

# A simple ROS2 bag file interface

This Python package wraps and documents functionality for reading data from bag 
files generated by [ROS2][ros2]. Bag files (or "bags") are the standard via 
which ROS2 stores data to disk. For an introduction to bag files, please see 
the ROS2 documentation that explains 
[recording and playing back data][intro_to_bags].

The purpose of this package is to facilitate direct reading of data from bag 
files that have been recorded by ROS.[^1] The 
[ROS 2 bag design document][design_document] explains the motivation and 
approach to data storage, and the [rosbag2][rosbag2_package] package provides 
an official implementation (C++ and Python). However, documentation of the 
[rosbag2 API][rosbag2_api] is _currently_ both scattered and limited, as are 
recommended best practices for working with bags. This package is intended to 
aggregate documentation about existing ROS2 functionality and to illustrate its 
usage. This package is intended only to fill a temporary gap, and it is 
expected that later versions of ROS2 (Jazzy and beyond) will make it obsolete.

[^1]: Note that reading data directly from bags is different from playing data 
      back. The latter functionality is amply explained in the ROS2 
      documentation.

## Installation

The [rosbag2][rosbag2_package] package must be installed. This does not 
necessarily require that ROS2 must be [installed][ros2_installation].

[ros2_installation]: https://docs.ros.org/en/humble/Installation.html

With the rosbag2 package installed, no further steps are required, as long as 
the package is available on the Python path (e.g., via 
[PYTHONPATH][pythonpath]).

A `setup.cfg` file has been provided, to facilitate package installation via 
[setuptools][setuptools]. Package installation can be accomplished via the 
command:

```
pip install path/to/nml_bag
```

## Quickstart / Usage

Basic usage of the package follows this pattern:

1. Initialize a ROS2 command prompt by [sourcing the ROS2 environment].
2. Import the package:
   ```python
   import nml_bag
   ```
3. Initialize a Reader object:
   ```python
   reader = nml_bag.Reader('path/to/bag.mcap', topics=['topic_a', '/topic_b'])
   ```
4. Iterate through message records:
   ```
   for message_record in reader: print(message_record)
   ```
5. Alternatively, the `records` property will return all available message 
   records:
   ```
   records = reader.records
   ```

### Example

A usage [example](doc/markdown/example.md) is included in this package as 
[example.py](nml_bag/example.py). The example initializes a bag directory and 
a MCAP file `bag_test_0.mcap`. The bag file contains a single topic `test`, on 
which two string-type messages are recorded.

Roughly following the quickstart outline, the code for reading the bag is:

```python
from pprint import pprint
import nml_bag
reader = nml_bag.Reader('path/to/bag_test_0.mcap')
pprint(reader.records)
```

And the output is similar to:

```
[{'data': 'Hello World!',
  'time_ns': 1654207659885697659,
  'topic': 'test',
  'type': 'example_interfaces/msg/String'},
 {'data': 'Goodybye World!',
  'time_ns': 1654207659885798001,
  'topic': 'test',
  'type': 'example_interfaces/msg/String'}]
```

## A note about serialization and storage formats

By [default][rosbag2_serialization], ROS2 messages are serialized using the 
[Common Data Representation (CDR)][cdr] standard and stored using [MCAP] 
([since Iron]) -- "an open source container file format for multimodal log 
data". Formerly, data were stored using [sqlite 3][sqlite].

Note: Although the [sqlite3][sqlite3] package is part of the standard 
distribution of Python 3 -- and it can be used to interpret bag files -- it is 
recommended that the ROS2 API be used for decoding bag files wherever possible.




<!------------------------------------------------------------------------------
   References
------------------------------------------------------------------------------->

[rosbag2_serialization]: https://github.com/ros2/rosbag2#storage-format-plugin-architecture

[sqlite]: https://en.wikipedia.org/wiki/SQLite

[cdr]: https://en.wikipedia.org/wiki/Common_Data_Representation

[sqlite3]: https://docs.python.org/3/library/sqlite3.html

[MCAP]: https://mcap.dev/

[since Iron]: https://docs.ros.org/en/iron/Releases/Iron-Irwini-Complete-Changelog.html#ros2bag

[intro_to_bags]: https://docs.ros.org/en/ros2_documentation/humble/Tutorials/Ros2bag/Recording-And-Playing-Back-Data.html

[ros2]: https://docs.ros.org/en/ros2_documentation/humble/index.html

[design_document]: https://github.com/ros2/design/blob/ros2bags/articles/rosbags.md#-pagetitle-

[rosbag2_package]: https://github.com/ros2/rosbag2#rosbag2

[rosbag2_api]: https://github.com/ros2/design/blob/ros2bags/articles/rosbags.md#rosbag-api

[setuptools]: https://setuptools.pypa.io/en/latest/userguide/quickstart.html#basic-use

[pythonpath]: https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPATH

[sourcing the ROS2 environment]: https://docs.ros.org/en/galactic/Tutorials/Workspace/Creating-A-Workspace.html#source-ros-2-environment




 Notes from Reader class
    -----
    
    In the current version of the ROS2 bag package, ``seek`` functionality has 
    not yet been implemented_. Until this is implemented, we recommend opening 
    a new :py:class`Reader` each time the position is to be reset.
    
    .. todo: Consider deriving this class from Iterator_ of the 
             `collections.abc` package. Multiple inheritence and the ABC 
             metaclass will conflict, so perhaps it should be distinct.
    
    .. _implemented: https://github.com/ros2/rosbag2/blob
                     /fada54cc2c93d4238f3971e9ce6ea0006ac85c8c/rosbag2_cpp
                     /src/rosbag2_cpp/readers/sequential_reader.cpp#L198
    .. _Iterator: https://docs.python.org/3/library
                  /collections.abc.html#collections-abstract-base-classes